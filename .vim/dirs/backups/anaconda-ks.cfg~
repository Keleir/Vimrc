# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
url --url=http://172.172.170.11:88/iso/6.5
lang en_US.UTF-8
keyboard us
network --onboot yes --device em1 --mtu=1500 --bootproto dhcp --hostname 111
network --onboot no --device em2 --bootproto dhcp --noipv6 --hostname 111
network --onboot no --device em3 --bootproto dhcp --noipv6 --hostname 111
network --onboot no --device em4 --bootproto dhcp --noipv6 --hostname 111
rootpw  --iscrypted $1$root$GW872S0CPJMETAxxvDcsk0
# Reboot after installation
reboot
firewall --disabled
authconfig --enableshadow --enablemd5
selinux --disabled
timezone --utc Asia/Shanghai
bootloader --location=mbr --driveorder=sda,sdb,sdc,sdd,sde,sdf,sdg,sdh --append="crashkernel=auto rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
#clearpart --all --initlabel

#part / --fstype=ext4 --size=40960
#part swap --size=16384
#part /data0 --fstype=ext4 --grow --size=100








repo --name="CentOS"  --baseurl=http://172.172.170.11:88/iso/6.5 --cost=100

%packages --ignoremissing
@Base
@Core
@base
@chinese-support
@core
@development
@server-policy
ftp
ipmitool
iptraf
lrzsz
net-snmp
nmap
ntp
sgpio
telnet
tree
zlib-devel
-mysql-libs
-postfix

%end

%pre
if [ `lsmod|grep cciss 2>/dev/null|wc -l` != 0 ]; then
cat > /tmp/fdisk << EOF1
bootloader --location=mbr --driveorder=cciss/c0d0
zerombr
clearpart --all --initlabel
part / --fstype ext4 --size=40960 --ondisk=cciss/c0d0
part swap --size=16384 --ondisk=cciss/c0d0
part /data0 --fstype ext4 --size=100 --grow --ondisk=cciss/c0d0
EOF1
else
cat > /tmp/fdisk << EOF2
bootloader --location=mbr --driveorder=sda
zerombr
clearpart --all --initlabel
part / --fstype ext4 --size=40960 --ondisk=sda
part swap --size=16384 --ondisk=sda
part /data0 --fstype ext4 --size=100 --grow --ondisk=sda
EOF2
fi

%end

%post --interpreter=/bin/bash
# 设置IP
#setIp(){
sed -i 's/quiet/quiet biosdevname=0/' /boot/grub/grub.conf
mv /etc/sysconfig/network-scripts/ifcfg-em1 /etc/sysconfig/network-scripts/ifcfg-eth0
mv /etc/sysconfig/network-scripts/ifcfg-em2 /etc/sysconfig/network-scripts/ifcfg-eth1
mv /etc/sysconfig/network-scripts/ifcfg-em3 /etc/sysconfig/network-scripts/ifcfg-eth2
mv /etc/sysconfig/network-scripts/ifcfg-em4 /etc/sysconfig/network-scripts/ifcfg-eth3
sed -i 's/em1/eth0/g' /etc/sysconfig/network-scripts/ifcfg-eth0
sed -i 's/em2/eth1/g' /etc/sysconfig/network-scripts/ifcfg-eth1
sed -i 's/em3/eth2/g' /etc/sysconfig/network-scripts/ifcfg-eth2
sed -i 's/em4/eth3/g' /etc/sysconfig/network-scripts/ifcfg-eth3
#######network###########
/sbin/ifconfig em1 172.17.44.60/22
/sbin/route add default gw 172.17.44.254
echo "DEVICE=eth0
BOOTPROTO=static
ONBOOT=yes
IPADDR=172.17.44.60
NETMASK=255.255.252.0
#GATEWAY=172.17.44.254
GATEWAY=172.17.47.254
HWADDR=E0:DB:55:13:7F:A4" > /etc/sysconfig/network-scripts/ifcfg-eth0
cat > /etc/resolv.conf << EOF
nameserver 172.17.1.134
nameserver 192.168.143.86
EOF
/etc/rc.d/init.d/network restart
echo "127.0.0.1 111 localhost.localdomain localhost" >/etc/hosts

#modprobe ipmi_msghandler
#modprobe ipmi_devintf
#modprobe ipmi_si
#modprobe ipmi_poweroff
#modprobe ipmi_watchdog
#
#
#loip=`ipmitool lan print|grep "IP Address *:"|awk '{print $4}'|awk -F "." '{print $2}'`
#
#if [ "$loip" -eq 168 ]
#then
#   ipaddr=`ipmitool lan print | grep "IP Address *:" | sed s"/.*: 10/192/"`
#   gateway="192.168.143.254"
#else
#   ipaddr=`ipmitool lan print | grep "IP Address *:" | sed s"/.*: 10/172/"`
#   gateway=`ipmitool lan print | grep "Default 172.17.44.254 IP" | awk '{print $5}'|sed "s/^10/172/"`
#fi
##loip=`ipmitool lan print|grep "IP Address *:"|awk '{print $4}'|awk -F "." '{print $2}'`
##
##if [ "$loip" -eq 17 ]
##then
##    ipaddr=`ipmitool lan print|grep "IP Address *:"|sed s"/^.*10/172/"`
##    gateway=`ipmitool lan print|grep "Default 172.17.44.254 IP"|awk '{print $5}'|sed "s/^10/172/"`
##else
##    ipaddr=`ipmitool lan print|grep "IP Address *:"|sed s"/^.*10/192/"`
##    gateway="192.168.143.254"
##fi
#
#netmask=`ipmitool lan print|grep "Subnet Mask"|awk '{print $4}'`
#
#
#cat > /etc/sysconfig/network-scripts/ifcfg-eth0 << EOF
#DEVICE=eth0
#BOOTPROTO=static
#ONBOOT=yes
#IPADDR=$ipaddr
#NETMASK=$netmask
#GATEWAY=$gateway
#EOF
#
#/etc/init.d/network restart
#}
#setIp
#
## 重启后执行一次
##cat >> /etc/rc.d/rc.local << EOF
##wget 172.17.44.113/iso/setup.sh -O /root/setup.sh
##chmod 645 /root/setup.sh
##/root/setup.sh > /root/setup.log 2>&1
##EOF
##
%end
